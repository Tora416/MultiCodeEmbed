
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
# include "crc32.h"

unsigned char frame[1546];  

unsigned char data[] = {0x64,0x62,0x12,0x15,0x45,0x55,0x11,0x33,0x55,0x44,
                        0x22,0x55,0x52,0x22,0x55,0x66,0x33,0x55,0x88,0x66,
                        0x45,0xaa,0xa2,0xa2,0xb2,0x13,0x56,0x85,0x25,0x36,
                        0x41,0x85,0x96,0x31,0x65,0x42,0x62,0x32,0x42,0x62,
                        0x42,0x23,0x52,0xb5,0xa6,0xc3,0xd2,0xd2,0xd5,0xd5,
                        0xd5,0xd3,0xd3,0xd3,0xd1,0x62,0x12,0x15,0x45,0x55,
                        0x11,0x33,0x55,0x44,0x22,0x55,0x52,0x22,0x55,0x66,
                        0x33,0x55,0x88,0x66,0x45,0xaa,0xa2,0xa2,0xb2,0x13,
                        0x56,0x85,0x25,0x36,0x41,0x85,0x96,0x31,0x65,0x42,
                        0x62,0x32,0x42,0x62,0x42,0x23,0x52,0xb5,0xa6,0xc3,
                        0xd2,0xd2,0xd5,0xd5,0xd5,0xd3,0xd3,0xd3,0xd1,0x62,
                        0x12,0x15,0x45,0x55,0x11,0x33,0x55,0x44,0x22,0x55,
                        0x52,0x22,0x55,0x66,0x33,0x55,0x88,0x66,0x45,0xaa,
                        0xa2,0xa2,0xb2,0x13,0x56,0x85,0x25,0x36,0x41,0x85,
                        0x96,0x31,0x65,0x42,0x62,0x32,0x42,0x62,0x42,0x23,
                        0x52,0xb5,0xa6,0xc3,0xd2,0xd2,0xd5,0xd5,0xd5,0xd3,
                        0xd3,0xd3,0xd1,0x62,0x12,0x15,0x45,0x55,0x11,0x33,
                        0x55,0x44,0x22,0x55,0x52,0x22,0x55,0x66,0x33,0x55,
                        0x88,0x66,0x45,0xaa,0xa2,0xa2,0xb2,0x13,0x56,0x85,
                        0x25,0x36,0x41,0x85,0x96,0x31,0x65,0x42,0x62,0x32,
                        0x42,0x62,0x42,0x23,0x52,0xb5,0xa6,0xc3,0xd2,0xd2,
                        0xd5,0xd5,0xd5,0xd3,0xd3,0xd3,0xd1,0x62,0x12,0x15,
                        0x45,0x55,0x11,0x33,0x55,0x44,0x22,0x55,0x52,0x22,
                        0x55,0x66,0x33,0x55,0x88,0x66,0x45,0xaa,0xa2,0xa2,
                        0xb2,0x13,0x56,0x85,0x25,0x36,0x41,0x85,0x96,0x31,
                        0x65,0x42,0x62,0x32,0x42,0x62,0x42,0x23,0x52,0xb5,
                        0xa6,0xc3,0xd2,0xd2,0xd5,0xd5,0xd5,0xd3,0xd3,0xd3,
                        0xd1,0xa6,0xc3,0xd2,0xd2,0xd5,0xd5,0xd5,0xd3,0xd3};
unsigned char sta_addr[6] = {0x11,0x33,0x55,0x44,0x22,0x55};  
unsigned char des_addr[6] = {0x42,0x23,0x52,0xb5,0xa6,0xc3};  
unsigned short protocol = 1; 


void welcome()
{
    printf("[INFO] Usage: frame sender process.\n");
}

 
void output_octal(unsigned char *x,unsigned int len) {
    int i;
    for (i =0;i<len;i++) {
        printf("%02x",x[i]);
        if (i != len-1) printf(" ");
    }
    printf("\n");
}

 
int frame_construction(unsigned char *sta_addr, unsigned char *des_addr,
                        unsigned short protocol, unsigned char *payload,
                        unsigned int payload_len)
{   
    
    if(payload_len < 46){
        printf("[Error] Payload length too low!\n");
        exit(1);
    }else if(payload_len >1500){
        printf("[Error] Payload length too long!\n");
        exit(1);
    }

    memcpy(&frame[0],des_addr,6);
    memcpy(&frame[6],sta_addr,6);
    memcpy(&frame[12],&protocol,sizeof(protocol));
    memcpy(&frame[14],payload,payload_len);
    init_crc_table();
    unsigned int crc32_result = crc32(frame,14+payload_len);
    
    memcpy(&frame[14+payload_len],&crc32_result,sizeof(crc32_result));
        unsigned char crc32_result_[4];
    memcpy(crc32_result_,&crc32_result,sizeof(crc32_result));
    
    
    printf("******Received frame information******\n");
    printf("Start address: %x\n",sta_addr);
    printf("Des address  : %x\n",des_addr);
    printf("protocol     : %x\n",protocol);
    printf("payload      : %x\n",payload);
    printf("CRC32        : ");
    output_octal(crc32_result_,4);
    printf("**************************************\n");
    
    return payload_len+6+6+sizeof(protocol)+sizeof(crc32_result);
}

 
int send_frame(unsigned char *frame, unsigned int frame_len){
    FILE *file = fopen("pipe.bin", "wb+");
    if(file == NULL)
    {
        printf("[INFO] File open error!\n");
        return 0;
    }
    fwrite(&frame_len,sizeof(frame_len),1,file);
    fwrite(frame, sizeof(char), frame_len, file);
    fclose(file);
    printf("[INFO] Frame send success!\n");
    return 0;
}

int main(){
    unsigned int length;
    
    welcome();
    




    
    
    length = frame_construction(sta_addr,des_addr,protocol,data,sizeof(data));
    printf("Frame length: %d\n",length);
    frame[length-10] = ~frame[length-10];
    send_frame(frame,length);

    return 0;
}
